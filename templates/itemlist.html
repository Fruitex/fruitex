{% extends "itemlistbase.html" %}
{% load static %}
{% block category %}
<style>
  #category {
    width: 200px;
    float: left;
    position: relative;
    border: 1px solid #D3D3D3;
  }
  
  #cate-list {
    list-style-type: none;
  }
  
  #cate-head {
    font-weight: bold;
    font-size: 14px;
    color: white;
    background-color: #93d033;
    padding: 10px 10px;
    border: 1px solid #D3D3D3;
    margin: -1px;
  }

  .cate {
    padding: 10px 10px;
    border: 1px solid #D3D3D3;
    margin: -1px;
  }
  
  .cate:hover {
    background-color: #e6ffbc;
  }

  .sub-cate {
    left: 200px;
    position: absolute;
    background-color: white;
    z-index: 10;
    border: 1px solid #D3D3D3;
    padding: 5px 10px;
    top: -1px;
  }
  
  .cate-sub-header {
    width: 100%;
    height: 5px;
    margin-bottom: 10px;
  }
  .cate-sub-list {
    list-style-type: none;
    margin-right: 10px;
    padding-bottom: 10px;
  }

  .cate-sub-list-item {
    padding-top: 5px;
    color: #6E6E6E;
  }

  .cate-sub-list-header {
    font-weight: bold;
    font-size: 13px;
    margin-top: 5px;
    margin-bottom: 10px;
    
  }
  
  #ad-and-items {
    width: 800px;
    float: right;
  }

  #ad {
    height: 200px;
    width: 800px;
    padding: 0px 8px;
  }

  #items {
    height: 400px;
    width: 800px;
  }
</style>
<script>
  function getCategoryId(s) {
    return 'cate-' + s.toLowerCase().replace(/[^a-z]/g, '');
  }

  function getCateHoverInHandler(c) {
    return function () {
      $('.sub-cate').hide();
      $('#' + getCategoryId(c)).show();
    };
  }

  function getCateHoverOutHandler() {
    return function () {
      $('.sub-cate').hide();
    };
  }

  (function (cate) {
    function getCateNum(c) {
      var res = 0;
      for (var sc in cate[c]) {
        res += cate[c][sc].length;
      }
      return res;
    }
    var cate_lst = $('<ul>').attr('id', 'cate-list');
    cate_lst.append($('<li>').attr('id', 'cate-head').text("Category"));
    for (var c in cate) {
      cate_lst.append($('<li>').attr('class', 'cate').text(c).hover(getCateHoverInHandler(c), getCateHoverOutHandler()));
      var sub_cate = $('<div>').attr('class', 'sub-cate')
        .attr('id', getCategoryId(c)).hide()
        .hover(function(){$(this).show();}, function(){$(this).hide()});
      $('#category').append(sub_cate);
      var columnNum = Math.ceil(getCateNum(c)/15);
      var containers = [];
      sub_cate.css('width', ((150 + 8) * columnNum) + 'px');
   
      var cate_sub_header = $('<div>').attr('class', 'cate-sub-header').css('background-color', '#b4f943');
      sub_cate.append(cate_sub_header);
   
      for (var i = 0; i < columnNum ; i++) {
        var col = $('<div>').css({'float': 'left', 'width': '150px', 'height': '100%'});
        sub_cate.append(col);
        containers.push(col);
      }
      var idx = 0;
      for (var sc in cate[c]) {
        var cate_sub_lst = $('<ul>').attr('class', 'cate-sub-list');
        containers[idx].append(cate_sub_lst);
        idx = (idx + 1) % columnNum;
        cate_sub_lst.append($('<li>').attr('class', 'cate-sub-list-header').text(sc))
        for (var i in cate[c][sc]) {
          cate_sub_lst.append($('<li>')
              .attr('class', 'cate-sub-list-item')
              .text(cate[c][sc][i]));
        }
      }
    }
    $('#category').append(cate_lst);
  })({{category | safe}}); // render category

  /*
  <div class = "item-container">
    <div class="item-info-wrapper">
      <!-- Hard code for item image -->
      <div class = "item-image"></div>
      <div class = "item-name"> {{ item.name }} </div>
      <p class = "item-price"> ${{ item.price }} </p>
      <p class = "item-category"> {{ item.category }} </p>
      </div>
    <div class="btn-add-container">
      <img class="btn-add" src= {% static "imgs/btn_add.png" %}>
    </div>
  </div>
  */
  var showItems = function (items) {
    var itemList = $('#item-list').empty();
    for (var i = 0; i < items.length; i++) {
      var item = items[i];
      var itemContainer = $('<div>').attr('class', 'item-container');
      itemList.append(itemContainer);
      var itemInfo = $('<div>').attr('class', 'item-info-wrapper')
          .append($('<div>').attr('class', 'item-image'))
          .append($('<div>').attr('class', 'item-name').text(item.name))
          .append($('<div>').attr('class', 'item-price').text(item.price))
          .append($('<div>').attr('class', 'item-category').text(item.category));
      var btn = $('<div>').attr('class', 'btn-add-container')
          .append($('<img>')
              .attr('class', 'btn-add')
              .attr('src', '{% static "imgs/btn_add.png" %}'));
      itemContainer.append(itemInfo).append(btn);
    }
  };
  var getAndShowItems = function(query, startId, num) {
    $.post('/items/getItems',
        {'startId' : startId, 'num' : num, 'query' : JSON.stringify(query)}, 
        function(data) {
          if (data.length > 0) {
            showItems(data);
            $('#navigator-prev').unbind('click').click(function() {
              if (startId > 0) {
                getAndShowItems(query, startId - num, num);
              }
            });
            $('#navigator-next').unbind('click').click(function() {
              getAndShowItems(query, startId + num, num)
            });
          }
        }, 'json');
  };
  $(document).ready(function() { 
    getAndShowItems({}, 0, 4);
  });
</script>
{% endblock %}
{% block ad %}
<img src={% static "imgs/ad_sobeys.png"%}>
{% endblock %}
{% block items %}
{% load staticfiles %}
<style>
  #item-list {
  }
  
  #navigator-prev {
    float : right;
    padding : 3px;
    margin-right : 5px;
    border : solid;
  }
  #navigator-next {
    float : right;
    padding : 3px;
    margin-left : 5px;
    border : solid;
  }

  .item-container {
    display: inline;
    width: 188px;
    height: 300px;
    margin-left:10px;
    margin-bottom:10px;
    float: left;
    border: 1px solid #D3D3D3;
    position: relative;
  }

  .item-info-wrapper {
    padding: 10px;
  }
  
  .item-image {
    margin-bottom: 10px;
    margin-right: auto;
    margin-left: auto;
    width: 165px;
    height: 212px;
    background: #f4f4f4;
  }
  
  .item-name {
    font-weight: bold;
    height: 30px;
    
  }
  
  .item-price {
    font-weight: bold;
    font-size: 12px;
    margin-bottom: 2px;
  }
  
  .item-category {
    font-size: 10px;
    color: gray;
  }
  
  .btn-add-container {
    position: absolute;
    height: 40px;
    margin: -1px;
    width: 100%;
    background: #f4f4f4;
    bottom: 0px;
    border: 1px solid #D3D3D3;
    display: none;
    
  }
  
  .btn-add {
    margin-top: 6px;
    margin-left: 40px;
  }
</style>
<div id = 'item-list'>
</div>
<div id = 'navigator'>
  <div id = 'navigator-next'>next</div>
  <div id = 'navigator-prev'>prev</div>
</div>
<script src={% static "javascript/itemlist.js"%}></script>
{% endblock %}


